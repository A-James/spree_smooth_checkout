<%= form_for @order, remote: true, :url => update_checkout_path(@order.state), :html => {:id => "checkout_form_#{@order.state}"} do |form| %>
  <div id="lock-summary" class="hidden-xs hidden-sm">

    <table data-hook="order_summary" class="table cart-summary">
      <%= render partial: 'spree/checkout/summary/line_items', locals: {order: @order} %>

      <tbody>
        <tr data-hook="item_total">
            <td><%= Spree.t(:item_total) %></td>
            <td class="text-right"><%= @order.display_item_total.to_html %></td>
        </tr>
      </tbody>
      <tbody id="summary-order-charges" data-hook>
        <% @order.adjustments.eligible.each do |adjustment| %>
          <% next if (adjustment.originator_type == 'Spree::TaxRate') and (adjustment.amount == 0) %>
          <% ### Spree_smooth_checkout_specific ###
             # Shipping methods are displayed below. %>
          <% next if (adjustment.originator_type == 'Spree::ShippingMethod') %>
          <% ### Spree_smooth_checkout_specific - FIN ###   %>
          <tr>
              <td><%= adjustment.label %> </td>
              <td class="text-right"><%= adjustment.display_amount.to_html %></td>
          </tr>
        <% end %>

        <% shipping_adjustments = @order.adjustments.eligible.select { |a| a.originator_type == 'Spree::ShippingMethod' } %>
        <% order_has_shipments = shipping_adjustments.any? { |a| a.originator_type == 'Spree::ShippingMethod' } %>
        <% if order_has_shipments %>
            <input type="hidden" name="is_summary" id="is_summary" value="true"/>
            <%= form.fields_for :shipments do |ship_fields| %>
              <% shipment = ship_fields.object %>
              <% adjustment = shipping_adjustments.find { |a| a.source_id == shipment.id } %>
              <tr>
                <td><%= adjustment.label %>:</td>
                <td class="text-right"><%= adjustment.display_amount.to_html %></td>
              </tr>
              <% if shipment.shipping_rates.count > 1 %>
                  <tr>
                    <td colspan="2">
                      <% shipment.shipping_rates.each do |rate| %>
                          <li class="list-group-item shipping-method">
                            <label>
                              <%= ship_fields.radio_button :selected_shipping_rate_id, rate.id %>
                              <span class="rate-name"><%= rate.name %></span>
                              <span class="badge rate-cost"><%= rate.display_cost %></span>
                            </label>
                          </li>
                      <% end %>
                    </td>
                  </tr>
              <% end %>
            <% end %>
            <% shipments_or_shipping_instructions_can_be_updated = form.object.shipments.any? { |s| s.shipping_rates.count > 1 } || Spree::Config[:shipping_instructions] %>
            <% if shipments_or_shipping_instructions_can_be_updated %>
                <tr>
                  <td colspan="2">
                    <% if Spree::Config[:shipping_instructions] %>
                        <p id="minstrs" data-hook>
                        <h4><%= Spree.t(:shipping_instructions) %></h4>
                        <%= form.text_area :special_instructions, :cols => 40, :rows => 4, :class => "form-control" %>
                        </p>
                    <% end %>
                    <div class="well text-right form-buttons" data-hook="buttons">
                      <%= submit_tag Spree.t(:update), :class => 'btn btn-lg btn-success' %>
                    </div>
                  </td>
                </tr>
            <% end %>
        <% end %>

      </tbody>
      <tbody>
        <tr data-hook="order_total">
          <td><%= Spree.t(:order_total) %></td>
          <td class="text-right">
            <h4><span id='summary-order-total'><%= @order.display_total.to_html %></span></h4>
          </td>
        </tr>
      </tbody>

      <% if @order.line_item_adjustment_totals.present? %>
        <tbody id="price-adjustments" data-hook="order_details_price_adjustments">
          <% @order.line_item_adjustment_totals.each do |label, total| %>
            <tr class="total">
                <td><%= label %></td>
                <td class="text-right"><span><%= total.to_html %></span></td>
            </tr>
          <% end %>
        </tbody>
      <% end %>
    </table>

    <% if Spree::Promotion.with_code.count >= 0 %>
      <div class="hidden" id="discount-code">
        <input type="hidden" name="is_summary" id="is_summary" value="true"/>
        <div class="input-group pull-right" data-hook='coupon_code'>
          <% # Blank value to stop the coupon code just entered being shown again. %>
          <%= form.text_field :coupon_code, :value => '', :class => 'form-control', :placeholder => "Discount code" %>
          <span class="input-group-btn">
            <%= submit_tag Spree.t(:update), :class => 'btn btn-success' %>
          </span>
        </div>
        <br/><br/>
      </div>
    <% end %>

    <div class="text-right">
        <a href="/faq">FAQs &amp; Shipping info</a>
    </div>

  </div>

  <script type="text/javascript">
    $('#lock-summary').width($('#checkout-summary').width() - 10) //remove 10px for bootstrap negative margins
  </script>
<% end %>
